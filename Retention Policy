‚úÖ Voici comment cr√©er ta balise ‚ÄúSupprimer apr√®s 2 ans (Archive)‚Äù en PowerShell

üîπ √âtape 1 ‚Äì Se connecter √† Exchange Online PowerShell
Connect-ExchangeOnline -UserPrincipalName ton.admin@entreprise.com

üîπ √âtape 2 ‚Äì Cr√©er la balise de r√©tention (Default Archive Policy Tag)


New-RetentionPolicyTag -Name "Supprimer apr√®s 2 ans (Archive)" `
-Type Archive `
-RetentionAction PermanentlyDelete `
-AgeLimitForRetention 730 `
-RetentionEnabled $true `
-Comment "Supprime automatiquement les e-mails dans la bo√Æte d‚Äôarchive apr√®s 2 ans"

üß† Explications :
Param√®tre	R√¥le
-Type Archive	indique que la balise s‚Äôapplique √† la bo√Æte d‚Äôarchive par d√©faut
-RetentionAction PermanentlyDelete	supprime les √©l√©ments apr√®s expiration
-AgeLimitForRetention 730	p√©riode de 2 ans
-RetentionEnabled $true	active la balise
-Comment	optionnel, pour documentation


üîπ √âtape 3 ‚Äì Cr√©er ou modifier une strat√©gie de r√©tention

Si tu veux en cr√©er une nouvelle :

New-RetentionPolicy -Name "MRM ‚Äì Supprimer apr√®s 2 ans (Archive)" `
-RetentionPolicyTagLinks "Supprimer apr√®s 2 ans (Archive)"


Sinon, pour l‚Äôajouter √† une strat√©gie existante :

Set-RetentionPolicy -Identity "Default MRM Policy" `
-RetentionPolicyTagLinks @{Add="Supprimer apr√®s 2 ans (Archive)"}

üîπ √âtape 4 ‚Äì Assigner la strat√©gie √† la bo√Æte aux lettres

Pour une bo√Æte sp√©cifique :

Set-Mailbox -Identity "relationclient@domitys.fr" -RetentionPolicy "MRM ‚Äì Supprimer apr√®s 2 ans (Archive)"


üîπ √âtape 5 ‚Äì Forcer le traitement (facultatif)

Pour appliquer imm√©diatement la politique sur une bo√Æte :

Start-ManagedFolderAssistant -Identity "relationclient@domitys.fr"  -Verbose

Start-ManagedFolderAssistant -Identity "ton.utilisateur@domaine.com" -Verbose



Get-Mailbox -Identity "relationclient@domitys.fr" | Get-MailboxStatistics | Select DisplayName,LastProcessedTime

Search-Mailbox -Identity  "relationclient@domitys.fr"  -SearchQuery "Received:<01/01/2024" -EstimateResultOnly


# D√©finir le nom de la recherche
$SearchName = "MailsPlusDe2Ans"

# Cr√©er la recherche

Connect-IPPSSession 

New-ComplianceSearch -Name $SearchName -ExchangeLocation "relationclient@domitys.fr" -ContentMatchQuery 'received:<01/01/2023'



‚öôÔ∏è R√©sultat

‚úÖ Tous les √©l√©ments de la bo√Æte d‚Äôarchive en ligne de l‚Äôutilisateur seront supprim√©s automatiquement apr√®s 2 ans.
‚úÖ La politique s‚Äôex√©cute automatiquement via le service Managed Folder Assistant (g√©r√© par Exchange Online).

üß≠ En r√©sum√©
√âtape	Action	Fait via
1	Connexion √† PowerShell	PowerShell
2	Cr√©er une balise ‚ÄúDefault Archive Policy Tag‚Äù	PowerShell
3	Cr√©er ou mettre √† jour une strat√©gie MRM	PowerShell
4	Assigner la strat√©gie √† une bo√Æte	PowerShell
5	Forcer l‚Äôex√©cution du Managed Folder Assistant	PowerShell



<# 
    Script : V√©rification de la strat√©gie MRM Exchange Online
    Auteur : ChatGPT (pour toi üòâ)
    Description : 
    V√©rifie la strat√©gie de r√©tention, les balises associ√©es 
    et la derni√®re ex√©cution du Managed Folder Assistant pour une bo√Æte aux lettres.
#>



# --- D√©finir l'utilisateur √† v√©rifier ---
$MailboxUser = "relationclient@domitys.fr"

Write-Host "=== V√©rification de la strat√©gie MRM pour $MailboxUser ===" -ForegroundColor Cyan

# --- R√©cup√©rer la strat√©gie MRM assign√©e ---
$Mailbox = Get-Mailbox -Identity $MailboxUser
$PolicyName = $Mailbox.RetentionPolicy
Write-Host "Strat√©gie MRM assign√©e : $PolicyName" -ForegroundColor Green

# --- Lister les balises associ√©es √† cette strat√©gie ---
Write-Host "`nBalises de r√©tention associ√©es :" -ForegroundColor Yellow
$Tags = (Get-RetentionPolicy -Identity $PolicyName).RetentionPolicyTagLinks
$Tags | ForEach-Object { Write-Host " - $_" }

# --- Obtenir la derni√®re ex√©cution du Managed Folder Assistant ---
Write-Host "`nDerni√®re ex√©cution du Managed Folder Assistant :" -ForegroundColor Yellow
$Stats = Get-MailboxStatistics -Identity $MailboxUser | Select DisplayName, LastProcessedTime
$Stats | Format-Table -AutoSize

# --- (Optionnel) V√©rifier les param√®tres de la balise sp√©cifique ---
Write-Host "`nD√©tails des balises :" -ForegroundColor Yellow
$Tags | ForEach-Object {
    $TagDetails = Get-RetentionPolicyTag -Identity $_ | Select Name, Type, RetentionAction, AgeLimitForRetention, RetentionEnabled
    $TagDetails | Format-Table -AutoSize
}

Write-Host "`n‚úÖ V√©rification termin√©e pour $MailboxUser" -ForegroundColor Cyan

Souhaites-tu que je te donne une version du script compl√®te, pr√™te √† copier-coller (avec variables que tu modifies pour ton tenant) ?


# Voir si l'archive est activ√©e
Get-Mailbox -Identity "relationclient@domitys.fr" | Select ArchiveStatus,ArchiveQuota,ArchiveName

# V√©rifier la strat√©gie de r√©tention associ√©e
Get-Mailbox -Identity "relationclient@domitys.fr" | Select RetentionPolicy

# Voir quelles balises sont incluses dans cette strat√©gie
(Get-RetentionPolicy -Identity "MRM ‚Äì Supprimer apr√®s 2 ans (Archive)").RetentionPolicyTagLinks


(Get-RetentionPolicy -Identity "MRM ‚Äì Supprimer apr√®s 2 ans (Archive)").RetentionPolicyTagLinks
Supprimer apr√®s 2 ans (Archive)
6 Mois Archivage



Get-RetentionPolicyTag -Identity "NomDeLaBalise"

Get-Mailbox -Identity "relationclient@domitys.fr" | Select DisplayName,ArchiveStatus,ArchiveQuota,ArchiveWarningQuota,ArchiveWarningSize,ArchiveDatabase,ArchiveDomain,ArchiveGuid,ArchiveState

DisplayName         : Relation Clients Domitys
ArchiveStatus       : Active
ArchiveQuota        : 110 GB (118,111,600,640 bytes)
ArchiveWarningQuota : 100 GB (107,374,182,400 bytes)
ArchiveWarningSize  :
ArchiveDatabase     : FRAP264DG395-db310
ArchiveDomain       :
ArchiveGuid         : 4d7ba634-b59d-4442-be67-159a72ca8791
ArchiveState        : Local


